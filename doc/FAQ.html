<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Frequently Asked Questions</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:matt@cadillac.net" />
</head>

<body style="background-color: white">

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#frequently_asked_questions">Frequently Asked Questions</a></li>
	<ul>

		<li><a href="#why_did_you_write_logmonster">Why did you write Logmonster?</a></li>
		<li><a href="#why_should_i_use_cronolog">Why should I use cronolog?</a></li>
		<li><a href="#why_not_use_one_file_per_vhost_so_you_don_t_have_to_split_them">Why not use one file per vhost so you don't have to split them?</a></li>
		<li><a href="#what_is_the_recommended_way_to_implement_logmonster">What is the recommended way to implement logmonster?</a></li>
		<li><a href="#how_do_i_enable_log_processing_for_a_virtual_domain">How do I enable log processing for a virtual domain?</a></li>
		<li><a href="#how_do_i_process_my_logs_hourly">How do I process my logs hourly?</a></li>
		<li><a href="#can_you_explain_how_to_use_the_b_stuff">Can you explain how to use the -b stuff?</a></li>
		<li><a href="#what_assumptions_do_logmonster_pl_make">What assumptions do logmonster.pl make?</a></li>
		<li><a href="#what_should_i_set_vhost_to">What should I set vhost to?</a></li>
		<li><a href="#can_i_use_this_with_web_servers_other_than_apache">Can I use this with web servers other than Apache?</a></li>
		<li><a href="#cronolog_and_selinux_are_not_playing_nicely">Cronolog and selinux are not playing nicely</a></li>
		<li><a href="#how_do_my_logs_need_to_be_set_up">How do my logs need to be set up?</a></li>
	</ul>

</ul>
<!-- INDEX END -->

<hr />
<p>Apache::Logmonster - Log Processing Utility<br>
Author: Matt Simerson.</p> <p>[ 
   <a href="/internet/www/logmonster.shtml">Install</a> | 
   <a href="/internet/www/logmonster/configure.shtml">Configure</a> | 
   FAQ | 
   <a href="/internet/www/logmonster/changelog.shtml">ChangeLog</a> | 
   <a href="/internet/www/logmonster/sample.shtml">Sample</a> ]
 </p> <hr><p>
</p>
<hr />
<h1><a name="frequently_asked_questions">Frequently Asked Questions</a></h1>
<p>
</p>
<h2><a name="why_did_you_write_logmonster">Why did you write Logmonster?</a></h2>
<p>Typical Scenario: You have a web server that serves your domain. You write a simple script to restart apache each night and pipe the logs off to your analyzer. It works just fine.</p>
<p>ISP/Hosting Scenario: Each server hosts many domains. You may also have load balanced servers (multiple machines) serving each domain. A tool like this is necessary to:</p>
<ol>
<li><strong><a name="item_collect_all_the_log_files_from_each_server">collect all the log files from each server</a></strong>

<li><strong><a name="item_host">split the logs based on the virtual <code>host(s)</code></a></strong>

<li><strong><a name="item_sort_them_into_cronological_order">sort them into cronological order</a></strong>

<li><strong><a name="item_feed_logs_into_analyzer">feed logs into analyzer</a></strong>

<li><strong><a name="item_logs">do something with the raw logs (compress, drop into vhost dir, etc)</a></strong>

</ol>
<p>
</p>
<h2><a name="why_should_i_use_cronolog">Why should I use cronolog?</a></h2>
<p>Read the Apache docs (<a href="http://httpd.apache.org/docs/2.0/logs.html">http://httpd.apache.org/docs/2.0/logs.html</a>) and all the caveats required to rotate logs, including restarting the server at the right time. Factor that into using several servers in different time zones and you will find it much more reliable to use cronolog. I have used cronolog for years and never had an issue.</p>
<p>
</p>
<h2><a name="why_not_use_one_file_per_vhost_so_you_don_t_have_to_split_them">Why not use one file per vhost so you don't have to split them?</a></h2>
<p>I tried that. One problem is that you end up with lots of open file descriptors (one per vhost). That only scales so far before you decide it is not a good idea. You still must collect the files from multiple servers and sort them before feeding them into your log processor. You might as well just start by having them all in one place.</p>
<p>
</p>
<h2><a name="what_is_the_recommended_way_to_implement_logmonster">What is the recommended way to implement logmonster?</a></h2>
<ul>
<li><strong><a name="item_adjust_customlog_and_add_the__25v_to_it_as_show_ab">Adjust CustomLog and add the %v to it as show above.</a></strong>

<li><strong><a name="item_if_you_aren_27t_already_using_cronolog_2c_start_2e">If you aren't already using cronolog, start. Wait a day.</a></strong>

<li><strong><a name="item_test_by_running__22logmonster__2di_day__2dn_22">Test by running ``logmonster -i day -n''</a></strong>

</ul>
<p>It will tell you what it is doing and everything should look reasonable. Correct anything you do not like (creating $statsdir for domains that should have it, etc) and then create a cron entry running ``logmonster.pl -d'' anytime after midnight. Read the output from logmonster in your mailbox for the next week. When you're confident everything is great, adjust crontab and add a ``-q'' to it so it stops emailing you (unless there's errors).</p>
<p>
</p>
<h2><a name="how_do_i_enable_log_processing_for_a_virtual_domain">How do I enable log processing for a virtual domain?</a></h2>
<p>Create the directory (``stats'' by default) within the vhost's DocumentRoot.</p>
<p>For example, the docroot for example.com is /home/example.com/html. To enable virtual host processing, create the directory /home/example.com/html/stats. Their statistics will be processed.</p>
<p>
</p>
<h2><a name="how_do_i_process_my_logs_hourly">How do I process my logs hourly?</a></h2>
<ul>
<li><strong><a name="item_set_cronolog_to__22_25y_2f_25m_2f_25d_2f_25h_22">Set cronolog to ``%Y/%m/%d/%H''</a></strong>

<li><strong><a name="item_run_logmonster_with__2di_hour">run logmonster with -i hour</a></strong>

<li><strong><a name="item_adjust_the_cron_entry_to_run_every_hour_2e">adjust the cron entry to run every hour.</a></strong>

</ul>
<p>If you use webalizer, get acquainted with webalizer -p and its limits.</p>
<p>
</p>
<h2><a name="can_you_explain_how_to_use_the_b_stuff">Can you explain how to use the -b stuff?</a></h2>
<p>Imagine you shut your server down at 0:55 last night to do some system maintenance. You brought it back up at at 1:05 (10 minutes later) but your cron job that runs logmonster at 1:00am did not run. The solution is to run logmonster manually.</p>
<p>Now, suppose you made an err that caused logmonster to not run for the last week. You return from vacation and notice the errors in your mailbox, because that <strong>is</strong> where you configured cron stuff to go, right? Now you set about to fix the problem.</p>
<p>The way to process old logs with logmonster is to use the -b option. In our example, we would run ``logmonster -i day -b7''. Logmonster will confirm the date with you and then dutifully process the logs from 7 days ago. Then run again with ``-d -b6'', etc until you are current.</p>
<p>
</p>
<h2><a name="what_assumptions_do_logmonster_pl_make">What assumptions do logmonster.pl make?</a></h2>
<ol>
<li><strong><a name="item_you_use_cronolog">You use cronolog</a></strong>

<li><strong><a name="item_you_have_enough_memory_to_fit_your_largest_zones_l">You have enough memory to fit your largest zones log file into RAM</a></strong>

<li><strong><a name="item_you_have_the_following_perl_modules_installed">You have the following Perl modules installed</a></strong>

<p>Most systems have all but Compress::Zlib installed</p>
<ul>
<li><strong><a name="item_filehandle">FileHandle</a></strong>

<li><strong><a name="item_posix">POSIX</a></strong>

<li><strong><a name="item_date_3a_3aformat">Date::Format</a></strong>

<li><strong><a name="item_file_3a_3acopy">File::Copy</a></strong>

<li><strong><a name="item_file_3a_3apath">File::Path</a></strong>

<li><strong><a name="item_date_3a_3aparse">Date::Parse</a></strong>

<li><strong><a name="item_compress_3a_3azlib">Compress::Zlib</a></strong>

</ul>
<li><strong><a name="item_your_logs_are_set_up_properly_2e_see__22apache_log">Your logs are set up properly. See ``Apache Logs''</a></strong>

<li><strong><a name="item_syncronized">The time on your web servers is syncronized (think NTP)</a></strong>

<li><strong><a name="item_you_use_webalizer_2c_http_2danalyze_2c_or_awstats_">You use webalizer, http-analyze, or AWstats for log processing</a></strong>

</ol>
<p>
</p>
<h2><a name="what_should_i_set_vhost_to">What should I set vhost to?</a></h2>
<p>vhost should be either a file with all your directives listed (ie, httpd.conf) or a directory (my favorite way) that contains files, each containing the VirtualHost and related directives for that Apache vhost. This is from the configuration file:</p>
<pre>
  ##
  # vhost -  This is where Logmonster learns about your Apache vhosts. If
  #          you list them in your httpd.conf, then this should be set to
  #          the full path of your httpd.conf file. 
  #
  #              vhost = /usr/local/etc/apache/httpd.conf
  #
  #          If you use a include directory for your vhosts, then this
  #          should be the full path to that directory.
  #
  #              vhost = /usr/local/etc/apache/vhosts
  #
  #vhost     = /etc/httpd/vhosts               # darwin
  #vhost     = /var/www/vhosts                 # linux
  #vhost     = /usr/local/etc/apache2/Includes  # freebsd
  #
  vhost     = /usr/local/etc/apache/Includes</pre>
<p>
</p>
<h2><a name="can_i_use_this_with_web_servers_other_than_apache">Can I use this with web servers other than Apache?</a></h2>
<p>Absolutely. Set up a configuration file with your vhost information in it and point logmonster at it. The format for each vhost is as follows:</p>
<pre>
    &lt;VirtualHost&gt;
      ServerName www.tnpi.net
      ServerAlias www.thenetworkpeople.net *.tnpi.net
      DocumentRoot /home/tnpi.net/html
    &lt;/VirtualHost&gt;</pre>
<p>Create as many vhost directives as you need and logmonster will parse them all. When you make changes to your web server, update this file as well.</p>
<p>All the other rules apply equally. You will want to use Apache's ELF (Extended Log Format) with the virtual hostname appended to the logs and pipe the logs to cronolog for reasons mentioned elsewhere.</p>
<p>
</p>
<h2><a name="cronolog_and_selinux_are_not_playing_nicely">Cronolog and selinux are not playing nicely</a></h2>
<p>I just finished installing cronolog on a selinux system (CentOS) with the sestatus set to enforcing. There were problems getting the permissions correct so that cronolog would be allowed to create files and dirs. I added this to solve the problem.</p>
<p>CentOS and RHEL4 and other RH clones use the file: /etc/selinux/targeted/contexts/files/file_contexts to store context info for files and dirs. In the above file add the location that you want logs to be written in if different than the standard /var/log/httpd like so:</p>
<p><code>/var/log/apache(/.*)?   system_u:object_r:httpd_log_t</code></p>
<p>This line would allow cronolog to create and write files in the new location. Hope this saves someone else the trouble. Another way to do this would be to use the command line chcon facility like so:</p>
<p><code>chcon -R -h -t httpd_log_t /var/log/apache</code></p>
<p>I have not rebooted my server or tested to see that on a system reset the chcon settings survive but I doubt it.</p>
<p>I hope this info saves someone else the trouble of looking it up and diagnosing a problem.
-- 
Lewis Bergman</p>
<p>
</p>
<h2><a name="how_do_my_logs_need_to_be_set_up">How do my logs need to be set up?</a></h2>
<p>The default version of Apache's ELF format is quite good. However, on a system with many virtual hosts, determing which vhost a particular entry is for can be quite difficult. I wrote a parser that was about 98% effective. However, there is a better way.</p>
<p>Apache supports the addition of a %v option in the LogFormat declaration. Using it appends the virtualhost that the hit was served for. This is 100% effective and makes it quite easy to detemine which vhost a log entry was served for. So, we recommend using a slightly modified version of Apache's Extended Log Format.</p>
<pre>
  LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot; %v&quot; combined
  CustomLog &quot;| /usr/local/sbin/cronolog /var/log/apache/%Y/%m/%d/access.log&quot; combined
  ErrorLog &quot;| /usr/local/sbin/cronolog /var/log/apache/%Y/%m/%d/error.log&quot;</pre>
<p>The LogFormat line is identical to its heir in the httpd.conf-default file except for the %v at the end. That little %v tells Apache to write the canonical servername (vhost) into the logfile.</p>
<p>The CustomLog line is pretty easy too. We pipe our logs to cronolog and it is set to store each days logs into an appropriately named directory. In this example, todays logs are stored on /var/log/apache/2006/10/01/access.log. That makes it very easy to grab an interval worth of logs to process.</p>

</body>

</html>
