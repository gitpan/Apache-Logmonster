<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Frequently Asked Questions</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:matt@mattbook.simerson.net" />
</head>

<body style="background-color: white">


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#frequently_asked_questions">Frequently Asked Questions</a></li>
	<ul>

		<li><a href="#why_did_you_write_logmonster">Why did you write Logmonster?</a></li>
		<li><a href="#why_should_i_use_cronolog">Why should I use cronolog?</a></li>
		<li><a href="#why_not_use_one_file_per_vhost_so_you_don_t_have_to_split_them">Why not use one file per vhost so you don't have to split them?</a></li>
		<li><a href="#what_is_the_recommended_way_to_implement_logmonster">What is the recommended way to implement logmonster?</a></li>
		<li><a href="#how_do_i_process_my_logs_hourly">How do I process my logs hourly?</a></li>
		<li><a href="#can_you_explain_how_to_use_the__b_stuff">Can you explain how to use the -b stuff?</a></li>
		<li><a href="#what_assumptions_do_logmonster_pl_make">What assumptions do logmonster.pl make?</a></li>
		<li><a href="#cronolog_and_selinux_are_not_playing_nicely">Cronolog and selinux are not playing nicely</a></li>
		<li><a href="#how_do_my_logs_need_to_be_set_up">How do my logs need to be set up?</a></li>
	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<p>Logmonster - Log Processing Utility<br>
Author: Matt Simerson.</p> <p>[ 
   <a href="/internet/www/logmonster.shtml">Install</a> | 
   <a href="/internet/www/logmonster/configure.shtml">Configure</a> | 
   FAQ | 
   <a href="/internet/www/logmonster/changelog.shtml">ChangeLog</a> | 
   <a href="/internet/www/logmonster/sample.shtml">Sample</a> ]
 </p> <hr><p>
</p>
<hr />
<h1><a name="frequently_asked_questions">Frequently Asked Questions</a></h1>
<p>
</p>
<h2><a name="why_did_you_write_logmonster">Why did you write Logmonster?</a></h2>
<p>Typical Scenario: A web server serves a domain. We write a simple script to restart apache each night and pipe the logs off to our analyzer. Or use newsyslog to do the same. It works fine.</p>
<p>ISP/Hosting Scenario: Each server hosts many domains. We may have load balanced servers (multiple machines) serving each domain. A tool like logmonster is necessary to:</p>
<ol>
<li><strong><a name="collect_all_the_log_files_from_each_server" class="item">collect all the log files from each server</a></strong>

</li>
<li><strong><a name="host" class="item">split the logs based on the virtual host(s)</a></strong>

</li>
<li><strong><a name="sort_them_into_cronological_order" class="item">sort them into cronological order</a></strong>

</li>
<li><strong><a name="feed_logs_into_analyzer" class="item">feed logs into analyzer</a></strong>

</li>
<li><strong><a name="logs" class="item">do something with the raw logs (compress, drop into vhost dir, etc)</a></strong>

</li>
</ol>
<p>
</p>
<h2><a name="why_should_i_use_cronolog">Why should I use cronolog?</a></h2>
<p>Read the Apache docs (<a href="http://httpd.apache.org/docs/2.0/logs.html">http://httpd.apache.org/docs/2.0/logs.html</a>) and all the caveats required to rotate logs, including restarting the server at the right time. Factor that into using several servers in different time zones and you will find it much more reliable to use cronolog. I have used cronolog for years and never had an issue.</p>
<p>
</p>
<h2><a name="why_not_use_one_file_per_vhost_so_you_don_t_have_to_split_them">Why not use one file per vhost so you don't have to split them?</a></h2>
<p>I tried that. I ended up with lots of open file descriptors (one per vhost). That doesn't scale well. One must still collect the files from multiple servers and sort them. Why not begin with them  all in one place?</p>
<p>
</p>
<h2><a name="what_is_the_recommended_way_to_implement_logmonster">What is the recommended way to implement logmonster?</a></h2>
<ul>
<li><strong><a name="adjust_customlog_and_add_the_v_to_it_as_show_above" class="item">Adjust CustomLog and add the %v to it as show above.</a></strong>

</li>
<li><strong><a name="if_you_aren_t_already_using_cronolog_start_wait_a_day" class="item">If you aren't already using cronolog, start. Wait a day.</a></strong>

</li>
<li><strong><a name="test_by_running_logmonster_i_day_n" class="item">Test by running &quot;logmonster -i day -n&quot;</a></strong>

</li>
</ul>
<p>It will tell you what it is doing and everything should look reasonable. Correct anything you do not like (creating $statsdir for domains that should have it, etc) and then create a cron entry running &quot;logmonster.pl -d&quot; anytime after midnight. Read the output from logmonster in your mailbox for the next week. When you're confident everything is great, adjust crontab and add a &quot;-q&quot; to it so it stops emailing you (unless there's errors).</p>
<p>
</p>
<h2><a name="how_do_i_process_my_logs_hourly">How do I process my logs hourly?</a></h2>
<ul>
<li><strong><a name="set_cronolog_to_y_m_d_h" class="item">Set cronolog to &quot;%Y/%m/%d/%H&quot;</a></strong>

</li>
<li><strong><a name="run_logmonster_with_i_hour" class="item">run logmonster with -i hour</a></strong>

</li>
<li><strong><a name="adjust_the_cron_entry_to_run_every_hour" class="item">adjust the cron entry to run every hour.</a></strong>

</li>
</ul>
<p>If you use webalizer, get acquainted with webalizer -p and its limits.</p>
<p>
</p>
<h2><a name="can_you_explain_how_to_use_the__b_stuff">Can you explain how to use the -b stuff?</a></h2>
<p>Imagine you shut your server down at 0:55 last night to do some system maintenance. You brought it back up at at 1:05 (10 minutes later) but your cron job that runs logmonster at 1:00am did not run. The solution is to run logmonster manually.</p>
<p>Now, suppose you made an err that caused logmonster to not run for the last week. You return from vacation and notice the errors in your mailbox, because that <strong>is</strong> where you configured cron stuff to go, right? Now you set about to fix the problem.</p>
<p>The way to process old logs with logmonster is to use the -b option. In our example, we would run &quot;logmonster -i day -b7&quot;. Logmonster will confirm the date with you and then dutifully process the logs from 7 days ago. Then run again with &quot;-d -b6&quot;, etc until you are current.</p>
<p>
</p>
<h2><a name="what_assumptions_do_logmonster_pl_make">What assumptions do logmonster.pl make?</a></h2>
<ol>
<li><strong><a name="you_use_cronolog" class="item">You use cronolog</a></strong>

</li>
<li><strong><a name="you_have_enough_memory_to_fit_your_largest_zones_log_file_into_ram" class="item">You have enough memory to fit your largest zones log file into RAM</a></strong>

</li>
<li><strong><a name="you_have_the_following_perl_modules_installed" class="item">You have the following Perl modules installed</a></strong>

<p>Most systems have all but Compress::Zlib installed</p>
<ul>
<li><strong><a name="filehandle" class="item">FileHandle</a></strong>

</li>
<li><strong><a name="posix" class="item">POSIX</a></strong>

</li>
<li><strong><a name="date_format" class="item">Date::Format</a></strong>

</li>
<li><strong><a name="file_copy" class="item">File::Copy</a></strong>

</li>
<li><strong><a name="file_path" class="item">File::Path</a></strong>

</li>
<li><strong><a name="date_parse" class="item">Date::Parse</a></strong>

</li>
<li><strong><a name="compress_zlib" class="item">Compress::Zlib</a></strong>

</li>
</ul>
</li>
<li><strong><a name="your_logs_are_set_up_properly_see_install" class="item">Your logs are set up properly. See &quot;INSTALL&quot;</a></strong>

</li>
<li><strong><a name="synchronized" class="item">The time on your web servers is synchronized (think NTP)</a></strong>

</li>
<li><strong><a name="you_use_webalizer_http_analyze_or_awstats_for_log_processing" class="item">You use webalizer, http-analyze, or AWstats for log processing</a></strong>

</li>
</ol>
<p>
</p>
<h2><a name="cronolog_and_selinux_are_not_playing_nicely">Cronolog and selinux are not playing nicely</a></h2>
<p>I just finished installing cronolog on a selinux system (CentOS) with the sestatus set to enforcing. There were problems getting the permissions correct so that cronolog would be allowed to create files and dirs. I added this to solve the problem.</p>
<p>CentOS and RHEL4 and other RH clones use the file: /etc/selinux/targeted/contexts/files/file_contexts to store context info for files and dirs. In the above file add the location that you want logs to be written in if different than the standard /var/log/httpd like so:</p>
<p><code>/var/log/apache(/.*)?   system_u:object_r:httpd_log_t</code></p>
<p>This line would allow cronolog to create and write files in the new location. Hope this saves someone else the trouble. Another way to do this would be to use the command line chcon facility like so:</p>
<p><code>chcon -R -h -t httpd_log_t /var/log/apache</code></p>
<p>I have not rebooted my server or tested to see that on a system reset the chcon settings survive but I doubt it.</p>
<p>I hope this info saves someone else the trouble of looking it up and diagnosing a problem.
-- 
Lewis Bergman</p>
<p>
</p>
<h2><a name="how_do_my_logs_need_to_be_set_up">How do my logs need to be set up?</a></h2>
<p>The default version of Apache's ELF format is quite good. However, on a system with many virtual hosts, determing which vhost a particular entry is for can be difficult. I wrote a parser that was about 98% effective. However, there is a better way.</p>
<p>Web servers support the addition of a %v option in the LogFormat declaration. It appends the virtualhost that the hit was served for. This is 100% effective and a bulletproof way to detemine which vhost a log entry was served for. We recommend a slightly modified version of Apache's Extended Log Format.</p>
<pre>
  LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot; %v&quot; combined
  CustomLog &quot;| /usr/local/sbin/cronolog /var/log/apache/%Y/%m/%d/access.log&quot; combined
  ErrorLog &quot;| /usr/local/sbin/cronolog /var/log/apache/%Y/%m/%d/error.log&quot;</pre>
<p>The LogFormat line is identical to its heir in except for the %v at the end. That little %v tells Apache to append the canonical servername (vhost) to each log entry.</p>
<p>The CustomLog line pipes our logs to cronolog, which is set to store each days logs in a date named directory. In this example, todays logs are stored on /var/log/apache/2006/10/01/access.log. This makes it very easy to grab an interval worth of logs to process.</p>

</body>

</html>
